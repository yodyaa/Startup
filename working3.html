<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <!-- ตั้งค่า viewport เพื่อป้องกันการซูม ย่อหรือขยาย -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>จัดการข้อมูลการสั่งซื้อและการดำเนินการ</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2.1/liff.js"></script>
    <script>
        // ฟังก์ชันสำหรับตรวจสอบและแสดงข้อความสั้นๆ ตาม user agent
        function getDeviceType() {
            const ua = navigator.userAgent;
            if (/android/i.test(ua)) {
                return "(ANDROID)";
            } else if (/iPhone|iPad|iPod/i.test(ua)) {
                return "(IOS)";
            } else if (/Windows/i.test(ua)) {
                return "(WINDOW)";
            } else if (/Macintosh/i.test(ua)) {
                return "(MAC)";
            } else {
                return "(UNKNOWN)";
            }
        }
        document.addEventListener('DOMContentLoaded', function () {
            // ตรวจสอบว่าเปิดผ่าน LINE (มือถือ) หรือไม่
            if (!navigator.userAgent.includes('Line')) {
                const deviceType = getDeviceType();
                document.body.innerHTML = `
          <div class="min-h-screen flex flex-col justify-center items-center bg-gray-100 p-4">
            <h1 class="text-2xl font-bold mb-4">ขออภัย กรุณาเปิดใน LINE ของมือถือน้าา~</h1>
            <p class="text-lg">คุณกำลังใช้งานผ่าน: ${deviceType}</p>
          </div>
        `;
            }
        });
    </script>

    <style>
        .bg-green-custom {
            background: #FFFFFF;
        }

        .disabled-button {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .bg-green {
            background: #33422b;
        }

        .border-green {
            border: 2px solid #33422b;
            border-radius: 10px;
        }

        .bg-inactive-tab {
            background: transparent;
            /* หรือสีที่คุณต้องการสำหรับแท็บที่ไม่ถูกเลือก */
        }

        /* เพิ่มสีพื้นหลังสำหรับแท็บที่ถูกเลือก */
        .active-tab {
            background-color: #33422b;
            /* สีเขียวที่ต้องการ */
            border-color: #33422b;
            /* สีขอบเขียว */
            color: white;
        }

        /* สีพื้นหลังสำหรับแท็บที่ไม่ถูกเลือก */
        .inactive-tab {
            background-color: #eff4e5;
            /* สีเทาอ่อน */
            border-color: transparent;
            color: #4b5563;
            /* สีเทาเข้ม */
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen p-6">
    <div class="max-w-md mx-auto">
        <!-- Tab Navigation -->
        <div class="flex border-b mb-4"> 
            <a href="https://liff.line.me/2006578535-YreM765V" class="p-4  rounded-lg bg-white">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" color="#000000" fill="none">
                <path d="M3.78879 9.03708C3.0814 9.42 1.22668 10.2019 2.35633 11.1803C2.90815 11.6582 3.52275 12 4.29543 12H8.70457C9.47725 12 10.0918 11.6582 10.6437 11.1803C11.7733 10.2019 9.9186 9.42 9.21121 9.03708C7.55241 8.13915 5.44759 8.13915 3.78879 9.03708Z" stroke="currentColor" stroke-width="1.5" />
                <path d="M8.75 4.27273C8.75 5.52792 7.74264 6.54545 6.5 6.54545C5.25736 6.54545 4.25 5.52792 4.25 4.27273C4.25 3.01753 5.25736 2 6.5 2C7.74264 2 8.75 3.01753 8.75 4.27273Z" stroke="currentColor" stroke-width="1.5" />
                <path d="M4 15C4 18.3171 6.68286 21 10 21L9.14286 19.2857" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M20 9C20 5.68286 17.3171 3 14 3L14.8571 4.71429" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M14.7888 19.0371C14.0814 19.42 12.2267 20.2019 13.3563 21.1803C13.9082 21.6582 14.5227 22 15.2954 22H19.7046C20.4773 22 21.0918 21.6582 21.6437 21.1803C22.7733 20.2019 20.9186 19.42 20.2112 19.0371C18.5524 18.1392 16.4476 18.1392 14.7888 19.0371Z" stroke="currentColor" stroke-width="1.5" />
                <path d="M19.75 14.2727C19.75 15.5279 18.7426 16.5455 17.5 16.5455C16.2574 16.5455 15.25 15.5279 15.25 14.2727C15.25 13.0175 16.2574 12 17.5 12C18.7426 12 19.75 13.0175 19.75 14.2727Z" stroke="currentColor" stroke-width="1.5" />
            </svg></a>
            <button id="tab-order"class="w-1/2 p-4 -mb-px border-b-2 rounded-l-lg active-tab focus:outline-none">ข้อมูลงาน</button>
            <button id="tab-operation"class="w-1/2 p-4 text-xs border-b-2 rounded-r-lg inactive-tab focus:outline-none">ข้อมูลการดำเนินการ</button>  
        </div>
        <!-- Tab Content -->
        <div id="tab-order-content">
            <!-- Content from HTML1 -->
            <div class="">
                <!-- Filter Section -->
                <div class="bg-green-custom rounded-lg p-4 mb-4">
                    <div class="flex flex-wrap -mx-2">
                        <div class="p-2 w-1/3">
                            <input type="text" id="order-filter-name" placeholder="ค้นหาตามชื่อ"
                                class="w-full border px-2 py-1 rounded-lg">
                        </div>
                        <div class="p-2 w-1/3">
                            <select id="order-filter-status" class="w-full border px-2 py-1 rounded-lg">
                                <option value="">สถานะ</option>
                                <option value="รอดำเนินการ">รอดำเนินการ</option>
                                <option value="ระหว่างเดินทาง">ระหว่างเดินทาง</option>
                                <option value="เริ่มดำเนินการ">เริ่มดำเนินการ</option>
                                <option value="ดำเนินงานเสร็จสิ้น">ดำเนินงานเสร็จสิ้น</option>
                            </select>
                        </div>
                        <div class="p-2 w-1/3">
                            <select id="order-sort-order" class="w-full border px-2 py-1 rounded-lg">
                                <option value="newest">ใหม่สุด</option>
                                <option value="oldest">เก่าสุด</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Card Container สำหรับงานที่ยังไม่เสร็จสิ้น -->
                <div id="order-card-container" class="grid grid-cols-1 gap-4 mb-4">
                    <!-- Card จะถูกแทรกที่นี่ -->
                </div>

                <!-- ตารางสำหรับงานที่เสร็จสิ้น -->
                <div id="order-completed-tasks-section" class="mb-8">
                    <h2 class="text-lg font-semibold mb-4">งานที่ดำเนินการเสร็จสิ้น</h2>
                    <table id="order-completed-table" class="min-w-full text-xs bg-white rounded-lg">
                        <thead>
                            <tr class="text-green-custom text-sm">
                                <th class="py-2 px-4 border">ชื่อ</th>
                                <th class="py-2 px-4 border">สถานะ</th>
                                <th class="py-2 px-4 border">การดำเนินการ</th>
                            </tr>
                        </thead>
                        <tbody class="text-sm"></tbody>
                    </table>
                </div>

                <!-- Loading Message -->
                <div id="order-loading-message" class="text-center text-gray-500 mt-4" style="display: none;">
                    กำลังโหลดข้อมูล...</div>

                <!-- Pagination Controls -->
                <div id="order-pagination-controls" class="flex justify-center mt-4 space-x-2">
                    <button id="order-prev-page"
                        class="bg-gray-300 text-gray-700 py-1 px-3 rounded-lg hover:bg-gray-400"
                        onclick="orderChangePage(currentOrderPage - 1)">ก่อนหน้า</button>
                    <div id="order-page-numbers" class="flex space-x-1">
                        <!-- ตัวเลขหน้าจะถูกสร้างที่นี่ -->
                    </div>
                    <button id="order-next-page"
                        class="bg-gray-300 text-gray-700 py-1 px-3 rounded-lg hover:bg-gray-400"
                        onclick="orderChangePage(currentOrderPage + 1)">ถัดไป</button>
                </div>

                <!-- Edit Modal -->
                <div id="order-edit-modal"
                    class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center">
                    <div class="bg-white p-6 rounded-lg w-full max-w-md">
                        <h2 class="text-xl mb-4">แก้ไขข้อมูลสถานะ</h2>
                        <form id="order-edit-form">
                            <input type="hidden" id="order-edit-idkey">
                            <!-- ช่องสำหรับเลือกสถานะ -->
                            <div class="mb-4">
                                <label for="order-edit-status" class="block mb-1">สถานะ</label>
                                <select id="order-edit-status" class="w-full border p-2 rounded-lg">
                                    <option value="เลื่อนนัด">เลื่อนนัด</option>
                                    <option value="ยกเลิก">ยกเลิก</option>
                                    <option value="ข้อมูลไม่ถูกต้อง">ข้อมูลไม่ถูกต้อง</option>
                                    <option value="ผิดพลาด">ผิดพลาด</option>
                                    <option value="อื่นๆ">อื่นๆ</option>
                                </select>
                            </div>
                            <!-- ช่องสำหรับกรอกชื่อผู้เกี่ยวข้อง -->
                            <div class="mb-4">
                                <label for="order-edit-name" class="block mb-1">ชื่อผู้เกี่ยวข้อง</label>
                                <input type="text" id="order-edit-name" class="w-full border p-2 rounded-lg" required>
                            </div>
                            <!-- ช่องสำหรับกรอกผู้รับผิดชอบ -->
                            <div class="mb-4">
                                <label for="order-edit-responsible" class="block mb-1">ผู้รับผิดชอบ</label>
                                <input type="text" id="order-edit-responsible" class="w-full border p-2 rounded-lg"
                                    required>
                            </div>
                            <!-- ช่องสำหรับกรอกหมายเหตุ Admin -->
                            <div class="mb-4">
                                <label for="order-edit-admin-note" class="block mb-1">หมายเหตุ Admin</label>
                                <textarea id="order-edit-admin-note" class="w-full border p-2 rounded-lg"></textarea>
                            </div>
                            <div class="flex justify-end mt-4 space-x-2">
                                <button type="button"
                                    class="bg-red-500 text-white p-3 w-1/3 rounded-lg hover:bg-red-700"
                                    onclick="orderCloseModal()">ยกเลิก</button>
                                <button type="submit"
                                    class="bg-blue-500 text-white p-3 w-2/3 rounded-lg hover:bg-blue-700">บันทึก</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-operation-content" class="hidden">
            <!-- ส่วนของฟิลเตอร์และรายการงาน -->
            <div class="w-full max-w-md mb-4">
                <div class="bg-green-custom rounded-lg p-4 mb-4">
                    <div class="flex flex-wrap gap-4">
                        <select id="operation-filter-status" onchange="operationApplyFilters()"
                            class="w-full sm:w-auto flex-1 border p-2 rounded-lg">
                            <option value="">ทุกสถานะ</option>
                            <option value="กำลังเดินทาง">กำลังเดินทาง</option>
                            <option value="ถึงจุดหมาย">ถึงจุดหมาย</option>
                            <option value="กำลังเริ่มงาน">กำลังเริ่มงาน</option>
                            <option value="งานเสร็จสิ้น">งานเสร็จสิ้น</option>
                            <option value="อนุมัติ">อนุมัติ</option>
                            <option value="รอดำเนินการ">รอดำเนินการ</option>
                            <option value="ปฏิเสธ">ปฏิเสธ</option>
                        </select>
                        <input type="text" id="operation-filter-name" placeholder="ค้นหาตามชื่อ"
                            class="w-full sm:w-auto flex-1 border p-2 rounded-lg" oninput="operationApplyFilters()">
                        <input type="hidden" id="operation-userId" placeholder="userId" readonly
                            class="w-full sm:w-auto flex-1 border p-2 rounded-lg bg-gray-100">
                    </div>
                </div>
            </div>

            <!-- รายการงาน -->
            <div id="operation-task-list" class="bg-white w-full max-w-md p-2"></div>
            <div id="operation-completed-tasks" class="bg-white w-full max-w-md p-2 mt-4"></div>
            <div id="operation-loading-message" class="text-center text-gray-500 mt-4" style="display: none;">
                กำลังโหลดข้อมูล...</div>

            <!-- Modal ดูรายละเอียดงาน -->
            <div id="operation-view-details-modal"
                class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4">
                <div class="bg-white p-6 rounded-lg w-full max-w-lg overflow-y-auto max-h-full">
                    <h2 class="text-xl mb-4">รายละเอียดข้อมูล</h2>
                    <div id="operation-details-content" class="space-y-2"></div>
                    <div class="flex justify-end mt-4 space-x-2">
                        <button type="button" class="bg-red-500 text-white py-1 px-3 rounded-lg hover:bg-red-700"
                            onclick="operationCloseViewDetailsModal()">ปิด</button>
                    </div>
                </div>
            </div>

            <!-- Modal กำลังเดินทาง -->
            <div id="operation-start-job-modal"
                class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4">
                <div class="bg-white p-6 rounded-lg w-full max-w-md overflow-y-auto max-h-full">
                    <h2 class="text-xl mb-4">กำลังเดินทาง</h2>
                    <form id="operation-start-job-form">
                        <input type="hidden" id="operation-start-job-idkey">
                        <div class="mb-4">
                            <label for="operation-start-status" class="block mb-1">สถานะ</label>
                            <select id="operation-start-status" class="w-full border p-2 rounded-lg" required>
                                <option value="กำลังเดินทาง" selected>กำลังเดินทาง</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="operation-start-time-inside" class="block mb-1">เวลา</label>
                            <input type="datetime-local" id="operation-start-time-inside"
                                class="w-full border p-2 rounded-lg" required>
                        </div>
                        <div class="mb-4">
                            <label for="operation-start-inside-note" class="block mb-1">หมายเหตุ</label>
                            <textarea id="operation-start-inside-note" class="w-full border p-2 rounded-lg"></textarea>
                        </div>
                        <div class="flex justify-end mt-4 space-x-2">
                            <button type="button" class="bg-red-500 text-white p-3 w-1/3 rounded-lg hover:bg-red-700"
                                onclick="operationCloseStartJobModal()">ยกเลิก</button>
                            <button type="submit"
                                class="bg-blue-500 text-white p-3 w-2/3 rounded-lg hover:bg-blue-700">บันทึก</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Modal ถึงจุดหมาย -->
            <div id="operation-process-job-modal"
                class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4">
                <div class="bg-white p-6 rounded-lg w-full max-w-md overflow-y-auto max-h-full">
                    <h2 class="text-xl mb-4">ถึงจุดหมาย</h2>
                    <form id="operation-process-job-form">
                        <input type="hidden" id="operation-process-job-idkey">
                        <div class="mb-4">
                            <label for="operation-process-status" class="block mb-1">สถานะ</label>
                            <select id="operation-process-status" class="w-full border p-2 rounded-lg" required>
                                <option value="ถึงจุดหมาย" selected>ถึงจุดหมาย</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="operation-process-time-process" class="block mb-1">เวลา</label>
                            <input type="datetime-local" id="operation-process-time-process"
                                class="w-full border p-2 rounded-lg" required>
                        </div>
                        <div class="mb-4">
                            <label for="operation-process-process-note" class="block mb-1">หมายเหตุ</label>
                            <textarea id="operation-process-process-note"
                                class="w-full border p-2 rounded-lg"></textarea>
                        </div>
                        <div class="flex justify-end mt-4 space-x-2">
                            <button type="button" class="bg-red-500 text-white p-3 w-1/3 rounded-lg hover:bg-red-700"
                                onclick="operationCloseProcessJobModal()">ยกเลิก</button>
                            <button type="submit"
                                class="bg-blue-500 text-white p-3 w-2/3 rounded-lg hover:bg-blue-700">บันทึก</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Modal กำลังเริ่มงาน (ขั้นตอนที่เพิ่มใหม่) -->
            <div id="operation-start-work-modal"
                class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4">
                <div class="bg-white p-6 rounded-lg w-full max-w-md overflow-y-auto max-h-full">
                    <h2 class="text-xl mb-4">กำลังเริ่มงาน</h2>
                    <form id="operation-start-work-form">
                        <input type="hidden" id="operation-start-work-idkey">
                        <div class="mb-4">
                            <label for="operation-start-work-status" class="block mb-1">สถานะ</label>
                            <select id="operation-start-work-status" class="w-full border p-2 rounded-lg" required>
                                <option value="กำลังเริ่มงาน" selected>กำลังเริ่มงาน</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="operation-start-work-time" class="block mb-1">เวลา</label>
                            <input type="datetime-local" id="operation-start-work-time"
                                class="w-full border p-2 rounded-lg" required>
                        </div>
                        <div class="mb-4">
                            <label for="operation-start-work-note" class="block mb-1">หมายเหตุ</label>
                            <textarea id="operation-start-work-note" class="w-full border p-2 rounded-lg"></textarea>
                        </div>
                        <div class="flex justify-end mt-4 space-x-2">
                            <button type="button" class="bg-red-500 text-white p-3 w-1/3 rounded-lg hover:bg-red-700"
                                onclick="operationCloseStartWorkModal()">ยกเลิก</button>
                            <button type="submit"
                                class="bg-blue-500 text-white p-3 w-2/3 rounded-lg hover:bg-blue-700">บันทึก</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Modal งานเสร็จสิ้น -->
            <div id="operation-complete-job-modal"
                class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4">
                <div class="bg-white p-6 rounded-lg w-full max-w-lg overflow-y-auto max-h-full">
                    <h2 class="text-xl mb-4">งานเสร็จสิ้น</h2>
                    <form id="operation-complete-job-form" enctype="multipart/form-data">
                        <input type="hidden" id="operation-complete-job-idkey">
                        <div class="mb-4">
                            <label for="operation-complete-status" class="block mb-1">สถานะ</label>
                            <input type="text" id="operation-complete-status" value="งานเสร็จสิ้น">
                        </div>
                        <div class="mb-4">
                            <label for="operation-complete-time-compress" class="block mb-1">เวลา</label>
                            <input type="datetime-local" id="operation-complete-time-compress"
                                class="w-full border p-2 rounded-lg" required>
                        </div>
                        <div class="mb-4">
                            <label for="operation-complete-compress-note" class="block mb-1">หมายเหตุ</label>
                            <textarea id="operation-complete-compress-note"
                                class="w-full border p-2 rounded-lg"></textarea>
                        </div>
                        <div class="mb-4">
                            <label for="operation-complete-compress-photo" class="block mb-1">รูปภาพ (ไม่บังคับ)</label>
                            <input type="file" id="operation-complete-compress-photo" accept="image/*"
                                class="w-full border p-2 rounded-lg">
                        </div>
                        <div class="flex justify-end mt-4 space-x-2">
                            <button type="button" class="bg-red-500 text-white p-3 w-1/3 rounded-lg hover:bg-red-700"
                                onclick="operationCloseCompleteJobModal()">ยกเลิก</button>
                            <button type="submit"
                                class="bg-blue-500 text-white p-3 w-2/3 rounded-lg hover:bg-blue-700">บันทึก</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        /* Tab Switching Logic */
        document.addEventListener('DOMContentLoaded', function () {
            const tabOrder = document.getElementById('tab-order');
            const tabOperation = document.getElementById('tab-operation');
            const tabOrderContent = document.getElementById('tab-order-content');
            const tabOperationContent = document.getElementById('tab-operation-content');

            // ฟังก์ชันเพื่อเปิดใช้งานแท็บ
            function activateTab(tab) {
                if (tab === 'order') {
                    // เปลี่ยนคลาสแท็บ
                    tabOrder.classList.add('active-tab');
                    tabOrder.classList.remove('inactive-tab');
                    tabOperation.classList.add('inactive-tab');
                    tabOperation.classList.remove('active-tab');

                    // แสดงเนื้อหาของแท็บที่ถูกเลือกและซ่อนแท็บอื่นๆ
                    tabOrderContent.classList.remove('hidden');
                    tabOperationContent.classList.add('hidden');

                    // โหลดข้อมูลการสั่งซื้อ (ถ้ายังไม่ถูกโหลด)
                    if (!window.orderInitialized) {
                        window.orderInitialize();
                    }
                } else if (tab === 'operation') {
                    // เปลี่ยนคลาสแท็บ
                    tabOperation.classList.add('active-tab');
                    tabOperation.classList.remove('inactive-tab');
                    tabOrder.classList.add('inactive-tab');
                    tabOrder.classList.remove('active-tab');

                    // แสดงเนื้อหาของแท็บที่ถูกเลือกและซ่อนแท็บอื่นๆ
                    tabOperationContent.classList.remove('hidden');
                    tabOrderContent.classList.add('hidden');

                    // โหลดข้อมูลการดำเนินการ (ถ้ายังไม่ถูกโหลด)
                    if (!window.operationInitialized) {
                        window.operationInitialize();
                    }
                }
            }

            // เพิ่ม Event Listeners สำหรับปุ่มแท็บ
            tabOrder.addEventListener('click', function () {
                activateTab('order');
            });

            tabOperation.addEventListener('click', function () {
                activateTab('operation');
            });

            // โหลดข้อมูลแท็บเริ่มต้น
            activateTab('order');
        });
    </script>
    <script>
        /* -------------------- HTML1 Scripts (Order Management) -------------------- */
        (function () {
            const WEB_APP_URL_ORDER = 'https://script.google.com/macros/s/AKfycbxeLbY6sR3LCqVU240VKUlBP3Zc6IihNbw-J-iBhbQ_bAEjx9zy5ezXrEzpiBEWzjvrbA/exec'; // URL ของ Google Apps Script Web App ของคุณ
            const LIFF_ID_ORDER = '2006504113-lVYLV6Xe'; // LIFF ID ของคุณ

            let orderTableData = [];
            let orderFilteredData = [];
            let orderCompletedData = [];
            let orderCurrentUserId = ''; // ตัวแปรเก็บ userId ปัจจุบัน
            let currentOrderPage = 1;
            const orderRowsPerPage = 10;
            let orderTotalPages = 1;
            let isOrderSubmitting = false; // ป้องกันการส่งข้อมูลซ้ำ

            async function orderInitializeLiff() {
                try {
                    await liff.init({ liffId: LIFF_ID_ORDER });
                    if (liff.isLoggedIn()) {
                        orderGetUserProfile();
                    } else {
                        liff.login();
                    }
                } catch (error) {
                    console.error('LIFF Initialization failed', error);
                    Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: 'ไม่สามารถเริ่มต้น LIFF ได้' });
                }
            }

            async function orderGetUserProfile() {
                try {
                    const profile = await liff.getProfile();
                    const userId = profile.userId;
                    orderCurrentUserId = userId;
                    console.log('User ID:', userId);
                    orderFetchData(userId);
                } catch (error) {
                    console.error('Error getting profile data:', error);
                    Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: 'ไม่สามารถดึงข้อมูลโปรไฟล์ผู้ใช้ได้' });
                }
            }

            async function orderFetchData(userId) {
                document.getElementById('order-loading-message').style.display = 'block';
                try {
                    const response = await fetch(`${WEB_APP_URL_ORDER}?sheet=Data`);
                    const result = await response.json();
                    if (result.success) {
                        orderTableData = result.data;
                        console.log('Data fetched:', orderTableData);
                        orderApplyFilters();
                    } else {
                        Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: result.message });
                    }
                } catch (error) {
                    console.error('Error fetching data:', error);
                    Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: 'ไม่สามารถโหลดข้อมูลได้' });
                } finally {
                    document.getElementById('order-loading-message').style.display = 'none';
                }
            }

            function orderDisplayCards(data) {
                const cardContainer = document.querySelector('#order-card-container');
                cardContainer.innerHTML = '';

                if (data.length === 0) {
                    cardContainer.innerHTML = '<p class="text-center text-gray-500">ไม่มีข้อมูลที่จะแสดง</p>';
                    return;
                }

                data.forEach(row => {
                    const card = document.createElement('div');
                    card.className = 'border border-green-700 rounded-lg p-4 mb-4 shadow-md bg-white';

                    const topRow = document.createElement('div');
                    topRow.className = 'grid grid-cols-3 gap-4 mb-4';

                    const dateDiv = document.createElement('div');
                    dateDiv.className = 'text-xs text-gray-500';
                    dateDiv.textContent = 'วันที่';
                    const dateValue = document.createElement('div');
                    dateValue.className = 'text-sm text-gray-800';
                    dateValue.textContent = orderFormatDate(row.Date);

                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'text-xs text-gray-500';
                    nameDiv.textContent = 'ชื่อ';
                    const nameValue = document.createElement('div');
                    nameValue.className = 'text-sm text-gray-800';
                    nameValue.textContent = row.Name + ' ' + row.Workorder;

                    const statusDiv = document.createElement('div');
                    statusDiv.className = 'text-xs text-gray-500';
                    statusDiv.textContent = 'สถานะ';
                    const statusValue = document.createElement('div');
                    statusValue.className = 'text-sm text-gray-800';
                    statusValue.textContent = orderTranslateStatus(row.Status);

                    const dateContainer = document.createElement('div');
                    dateContainer.appendChild(dateDiv);
                    dateContainer.appendChild(dateValue);
                    topRow.appendChild(dateContainer);

                    const nameContainer = document.createElement('div');
                    nameContainer.appendChild(nameDiv);
                    nameContainer.appendChild(nameValue);
                    topRow.appendChild(nameContainer);

                    const statusContainer = document.createElement('div');
                    statusContainer.appendChild(statusDiv);
                    statusContainer.appendChild(statusValue);
                    topRow.appendChild(statusContainer);

                    const bottomRow = document.createElement('div');
                    bottomRow.className = 'grid grid-cols-3 gap-4 text-sm';

                    const detailsButton = document.createElement('button');
                    detailsButton.className = 'bg-purple-700 text-white py-2 px-4 rounded-lg hover:bg-purple-800 transition w-full';
                    detailsButton.textContent = 'รายละเอียด';
                    detailsButton.onclick = () => orderViewDetails(row.IDkey);
                    detailsButton.setAttribute('aria-label', `ดูรายละเอียดของงาน ${row.Name}`);

                    const editButton = document.createElement('button');
                    editButton.className = 'bg-yellow-500 text-white py-2 px-4 rounded-lg hover:bg-yellow-600 transition w-full';
                    editButton.textContent = 'แจ้งเรื่อง';
                    editButton.onclick = () => orderOpenEditModal(row.IDkey);

                    const isDisabled = ['ระหว่างเดินทาง', 'เริ่มดำเนินการ', 'เสร็จสิ้น'].includes(row.Status);
                    const confirmButton = document.createElement('button');
                    confirmButton.className = `bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 transition w-full ${isDisabled ? 'disabled-button' : ''}`;
                    confirmButton.textContent = 'ยืนยันรับงาน';
                    if (!isDisabled) {
                        confirmButton.onclick = () => orderTakeJob(row.IDkey);
                    }
                    confirmButton.disabled = isDisabled;

                    bottomRow.appendChild(detailsButton);
                    bottomRow.appendChild(editButton);
                    bottomRow.appendChild(confirmButton);

                    card.appendChild(topRow);
                    card.appendChild(bottomRow);
                    cardContainer.appendChild(card);
                });
            }

            function orderDisplayCompletedTable(data) {
                const tableBody = document.querySelector('#order-completed-table tbody');
                tableBody.innerHTML = '';

                if (data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" class="py-2 px-4 border text-center text-gray-500">ไม่มีงานที่ดำเนินการเสร็จสิ้น</td></tr>';
                    return;
                }

                data.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
            <td class="py-2 px-4 border text-center">${row.Name}</td>
            <td class="py-2 px-4 border text-center">${orderTranslateStatus(row.Status)}</td>
            <td class="flex justify-between text-xs py-2 px-4 border text-center">
              <button class="bg-purple-700 text-white py-2 px-3 mr-1 rounded-lg hover:bg-purple-800 transition" onclick="orderViewDetails('${row.IDkey}')">รายละเอียด</button>
              <button class="bg-yellow-500 text-white py-2 px-3 rounded-lg hover:bg-yellow-600 transition" onclick="orderOpenEditModal('${row.IDkey}')">แจ้งเรื่อง</button>
            </td>
          `;
                    tableBody.appendChild(tr);
                });
            }

            function orderTranslateStatus(status) {
                switch (status.toLowerCase()) {
                    case 'อนุมัติ': return 'อนุมัติ';
                    case 'ยกเลิก': return 'ยกเลิก';
                    case 'ปฏิเสธ': return 'ปฏิเสธ';
                    case 'เริ่มดำเนินการ': return 'เริ่มดำเนินการ';
                    case 'เสร็จสิ้น': return 'เสร็จสิ้น';
                    default: return status;
                }
            }

            function orderFormatDate(dateString) {
                const date = new Date(dateString);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${day}/${month}/${year} ${hours}:${minutes}`;
            }
            window.orderViewDetails = function (idkey) {
                const row = orderTableData.find(row => row.IDkey === idkey);
                if (row) {
                    Swal.fire({
                        title: 'รายละเอียด',
                        html: `
        <div style="text-align: left;">
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="border: 1px solid #ddd; padding: 8px; width: 40%;"><b>ID Key:</b></td>
              <td style="border: 1px solid #ddd; padding: 8px;">${row.IDkey}</td>
            </tr>
             <tr>
              <td style="border: 1px solid #ddd; padding: 8px;"><b>ลำดับเคส:</b></td>
              <td style="border: 1px solid #ddd; padding: 8px;">${row.Workorder}</td>
            </tr>
            <tr>
              <td style="border: 1px solid #ddd; padding: 8px;"><b>ชื่อ:</b></td>
              <td style="border: 1px solid #ddd; padding: 8px;">${row.Name}</td>
            </tr>
            <tr>
              <td style="border: 1px solid #ddd; padding: 8px;"><b>ที่อยู่:</b></td>
              <td style="border: 1px solid #ddd; padding: 8px;">${row.Address}</td>
            </tr>
            <tr>
              <td style="border: 1px solid #ddd; padding: 8px;"><b>Map Link:</b></td>
              <td style="border: 1px solid #ddd; padding: 8px;">
                <a href="${row.Maplink}" target="_blank" class="bg-blue-500 text-white px-2 py-1 rounded-full text-xs">เปิดแผนที่</a>
              </td>
            </tr>
            <tr>
              <td style="border: 1px solid #ddd; padding: 8px;"><b>ชื่อหมู่บ้าน:</b></td>
              <td style="border: 1px solid #ddd; padding: 8px;">${row.Village}</td>
            </tr>
            <tr>
              <td style="border: 1px solid #ddd; padding: 8px;"><b>วันที่:</b></td>
              <td style="border: 1px solid #ddd; padding: 8px;">${orderFormatDate(row.Date)}</td>
            </tr>
            <tr>
              <td style="border: 1px solid #ddd; padding: 8px;"><b>รายละเอียด:</b></td>
              <td style="border: 1px solid #ddd; padding: 8px;">${row.Detail}</td>
            </tr>
            <tr>
              <td style="border: 1px solid #ddd; padding: 8px;"><b>หมายเหตุ:</b></td>
              <td style="border: 1px solid #ddd; padding: 8px;">${row.Note}</td>
            </tr>
            <tr>
              <td style="border: 1px solid #ddd; padding: 8px;"><b>เบอร์ติดต่อ:</b></td>
              <td style="border: 1px solid #ddd; padding: 8px;">
                <a href="tel:${row.Contact}" class="bg-green-500 text-white px-2 py-1 rounded-full text-xs">${row.Contact}</a>
              </td>
            </tr>
            <tr>
              <td style="border: 1px solid #ddd; padding: 8px;"><b>การชำระเงิน:</b></td>
              <td style="border: 1px solid #ddd; padding: 8px;">${row.Payment}</td>
            </tr>
            <tr>
              <td style="border: 1px solid #ddd; padding: 8px;"><b>สถานะ:</b></td>
              <td style="border: 1px solid #ddd; padding: 8px;">${orderTranslateStatus(row.Status)}</td>
            </tr>
            <tr>
              <td style="border: 1px solid #ddd; padding: 8px;"><b>ผู้รับผิดชอบ:</b></td>
              <td style="border: 1px solid #ddd; padding: 8px;">${row.Responsible}</td>
            </tr>
            <tr>
              <td style="border: 1px solid #ddd; padding: 8px;"><b>Admin:</b></td>
              <td style="border: 1px solid #ddd; padding: 8px;">${row.Admin}</td>
            </tr>
            <tr>
              <td style="border: 1px solid #ddd; padding: 8px;"><b>หมายเหตุ Admin:</b></td>
              <td style="border: 1px solid #ddd; padding: 8px;">${row.adminNote}</td>
            </tr>
          </table>
        </div>
      `,
                        confirmButtonText: 'ปิด'
                    });
                }
            }


            window.orderOpenEditModal = function (idkey) {
                const row = orderTableData.find(row => row.IDkey === idkey);
                if (row) {
                    document.getElementById('order-edit-idkey').value = row.IDkey;
                    document.getElementById('order-edit-status').value = row.Status;
                    // กำหนดค่าในช่อง "ชื่อผู้เกี่ยวข้อง"
                    document.getElementById('order-edit-name').value = row.Name;
                    document.getElementById('order-edit-responsible').value = row.Responsible;
                    document.getElementById('order-edit-admin-note').value = row.adminNote;
                    document.getElementById('order-edit-modal').classList.remove('hidden');
                }
            }

            window.orderCloseModal = function () {
                document.getElementById('order-edit-modal').classList.add('hidden');
            }

            document.getElementById('order-edit-form').addEventListener('submit', async function (e) {
                e.preventDefault();

                const submitButton = this.querySelector("button[type=submit]");
                const originalText = submitButton.textContent;
                submitButton.disabled = true;
                submitButton.textContent = 'กำลังอัพเดท...';

                const idkey = document.getElementById('order-edit-idkey').value;
                const status = document.getElementById('order-edit-status').value;
                const name = document.getElementById('order-edit-name').value.trim(); // ดึงค่าชื่อผู้เกี่ยวข้อง
                const responsible = document.getElementById('order-edit-responsible').value.trim();
                const adminNote = document.getElementById('order-edit-admin-note').value.trim();

                if (!idkey || !status || !name || !responsible) {
                    Swal.fire({ icon: 'warning', title: 'คำเตือน', text: 'กรุณากรอกข้อมูลที่จำเป็นให้ครบถ้วน' });
                    submitButton.disabled = false;
                    submitButton.textContent = originalText;
                    return;
                }

                try {
                    const response = await fetch(WEB_APP_URL_ORDER, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `method=updateOrder&idkey=${encodeURIComponent(idkey)}&status=${encodeURIComponent(status)}&name=${encodeURIComponent(name)}&responsible=${encodeURIComponent(responsible)}&adminNote=${encodeURIComponent(adminNote)}`
                    });
                    const result = await response.json();

                    if (result.success) {
                        Swal.fire({ title: 'สำเร็จ', text: result.message, icon: 'success' });
                        orderCloseModal();
                        orderFetchData(orderCurrentUserId);
                    } else {
                        Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: result.message });
                    }
                } catch (error) {
                    console.error('Error updating data:', error);
                    Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: 'ไม่สามารถอัปเดตข้อมูลได้' });
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = originalText;
                }
            });

            window.orderTakeJob = async function (idkey) {
                if (isOrderSubmitting) return;
                isOrderSubmitting = true;

                Swal.fire({
                    title: 'ยืนยันการรับงาน?',
                    text: `คุณต้องการเปลี่ยนสถานะของ Order ID: ${idkey} เป็น "เริ่มดำเนินการ" ใช่หรือไม่?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'ใช่, รับงาน',
                    cancelButtonText: 'ยกเลิก'
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        Swal.fire({
                            title: 'กำลังอัพเดท...',
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading();
                            }
                        });
                        try {
                            const response = await fetch(WEB_APP_URL_ORDER, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                                body: `method=takeJob&idkey=${encodeURIComponent(idkey)}`
                            });
                            const resultData = await response.json();
                            if (resultData.success) {
                                Swal.fire({ title: 'สำเร็จ', text: resultData.message, icon: 'success' });
                                orderFetchData(orderCurrentUserId);
                            } else {
                                Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: resultData.message });
                            }
                        } catch (error) {
                            console.error('Error updating data:', error);
                            Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: 'ไม่สามารถอัปเดตข้อมูลได้' });
                        } finally {
                            isOrderSubmitting = false;
                        }
                    } else {
                        isOrderSubmitting = false;
                    }
                });
            }

            function orderApplyFilters() {
                const filterName = document.getElementById('order-filter-name').value.toLowerCase();
                const filterStatus = document.getElementById('order-filter-status').value.toLowerCase();
                const sortOrder = document.getElementById('order-sort-order').value;

                orderFilteredData = orderTableData.filter(row => {
                    const matchesName = row.Name.toLowerCase().includes(filterName);
                    const matchesStatus = filterStatus ? row.Status.toLowerCase() === filterStatus : true;
                    const matchesUserId = row.UserIDresponsible === orderCurrentUserId;
                    return matchesName && matchesStatus && matchesUserId;
                });

                // กรองข้อมูล pending (รอดำเนินการ และเริ่มดำเนินการ)
                const pendingTasks = orderFilteredData.filter(row => {
                    let status = row.Status.toLowerCase();
                    return status === 'รอดำเนินการ' || status === 'เริ่มดำเนินการ';
                });
                // ข้อมูลอื่น ๆ ให้ไปอยู่ใน completed table
                orderCompletedData = orderFilteredData.filter(row => {
                    let status = row.Status.toLowerCase();
                    return status !== 'รอดำเนินการ' && status !== 'เริ่มดำเนินการ';
                });

                if (sortOrder === 'newest') {
                    pendingTasks.sort((a, b) => new Date(b.Date) - new Date(a.Date));
                    orderCompletedData.sort((a, b) => new Date(b.Date) - new Date(a.Date));
                } else if (sortOrder === 'oldest') {
                    pendingTasks.sort((a, b) => new Date(a.Date) - new Date(b.Date));
                    orderCompletedData.sort((a, b) => new Date(a.Date) - new Date(b.Date));
                }

                orderTotalPages = Math.ceil(pendingTasks.length / orderRowsPerPage);
                currentOrderPage = 1;
                orderSetupPagination();

                const paginatedData = orderPaginateData(pendingTasks, currentOrderPage);
                orderDisplayCards(paginatedData);
                orderDisplayCompletedTable(orderCompletedData);
            }


            function orderSetupPagination() {
                const pageNumbersContainer = document.getElementById('order-page-numbers');
                pageNumbersContainer.innerHTML = '';
                for (let i = 1; i <= orderTotalPages; i++) {
                    const pageButton = document.createElement('button');
                    pageButton.innerText = i;
                    pageButton.className = `px-3 py-1 rounded-lg ${i === currentOrderPage ? 'bg-blue-500 text-white' : 'bg-gray-300 text-gray-700 hover:bg-gray-400'}`;
                    pageButton.onclick = () => orderChangePage(i);
                    pageNumbersContainer.appendChild(pageButton);
                }
                document.getElementById('order-prev-page').disabled = currentOrderPage === 1;
                document.getElementById('order-next-page').disabled = currentOrderPage === orderTotalPages;
            }

            function orderChangePage(page) {
                if (page < 1 || page > orderTotalPages) return;
                currentOrderPage = page;
                orderSetupPagination();
                const pendingTasks = orderFilteredData.filter(row => row.Status.toLowerCase() !== 'เสร็จสิ้น');
                const paginatedData = orderPaginateData(pendingTasks, currentOrderPage);
                orderDisplayCards(paginatedData);
            }

            function orderPaginateData(data, page) {
                const start = (page - 1) * orderRowsPerPage;
                const end = start + orderRowsPerPage;
                return data.slice(start, end);
            }

            window.orderInitialize = function () {
                orderInitializeLiff();
                document.getElementById('order-filter-name').addEventListener('input', orderApplyFilters);
                document.getElementById('order-filter-status').addEventListener('change', orderApplyFilters);
                document.getElementById('order-sort-order').addEventListener('change', orderApplyFilters);
            };

            window.addEventListener('load', orderInitialize);

            function orderGetCurrentDateTimeGMT7() {
                const now = new Date();
                const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
                const gmt7Time = new Date(utc + (7 * 3600000));
                const year = gmt7Time.getFullYear();
                const month = String(gmt7Time.getMonth() + 1).padStart(2, '0');
                const day = String(gmt7Time.getDate()).padStart(2, '0');
                const hours = String(gmt7Time.getHours()).padStart(2, '0');
                const minutes = String(gmt7Time.getMinutes()).padStart(2, '0');
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            }
        })();

        /* -------------------- HTML Scripts (Operation Management) -------------------- */
        (function () {
            const WEB_APP_URL_OPERATION = 'https://script.google.com/macros/s/AKfycbxDoJxNMYZSM6LL7XLy86T0oXfEZPFmDfZbYGTf7-HO9ffWj5BKZPrP1M2bTLUfynE/exec'; // เปลี่ยนเป็น URL ของ Google Apps Script Web App ของคุณ
            const LIFF_ID_OPERATION = '2006578535-AJ8L642w'; // เปลี่ยนเป็น LIFF ID ของคุณ
 

            let operationCurrentUserId = '';
            let operationTableData = [];
            let currentPagePendingOperation = 1;
            let currentPageCompletedOperation = 1;
            const operationItemsPerPage = 10;

            async function operationInitializeLiff() {
                try {
                    await liff.init({ liffId: LIFF_ID_OPERATION });
                    if (liff.isLoggedIn()) {
                        operationGetUserProfile();
                    } else {
                        liff.login();
                    }
                } catch (error) {
                    console.error('LIFF Initialization failed', error);
                }
            }

            async function operationGetUserProfile() {
                try {
                    const profile = await liff.getProfile();
                    const userId = profile.userId;
                    operationCurrentUserId = userId;
                    document.getElementById('operation-userId').value = userId;
                    operationFetchData(userId);
                } catch (error) {
                    console.error('Error getting profile data:', error);
                }
            }

            async function operationFetchData(userId) {
                document.getElementById('operation-loading-message').style.display = 'block';
                try {
                    const response = await fetch(`${WEB_APP_URL_OPERATION}?sheet=Dataservice`);
                    const result = await response.json();
                    if (result.success) {
                        operationTableData = result.data;
                        operationApplyFilters(userId);
                    } else {
                        Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: result.message });
                    }
                } catch (error) {
                    console.error('Error fetching data:', error);
                    Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: 'ไม่สามารถโหลดข้อมูลได้' });
                } finally {
                    document.getElementById('operation-loading-message').style.display = 'none';
                }
            }

            function operationApplyFilters(userId = operationCurrentUserId) {
                const filterStatus = document.getElementById('operation-filter-status').value.toLowerCase();
                const filterName = document.getElementById('operation-filter-name').value.toLowerCase();

                const filteredData = operationTableData.filter(row => {
                    const matchesStatus = filterStatus ? row.status.toLowerCase().includes(filterStatus) : true;
                    const matchesName = filterName ? (row.Name || '').toLowerCase().includes(filterName) : true;
                    const matchesUserId = row.useridresponsible === userId;
                    return matchesStatus && matchesName && matchesUserId;
                });

                filteredData.sort((a, b) => {
                    const dateA = operationParseDateDDMMYYYYHHmm(a.timestamp);
                    const dateB = operationParseDateDDMMYYYYHHmm(b.timestamp);
                    return dateB - dateA;
                });

                currentPagePendingOperation = 1;
                currentPageCompletedOperation = 1;
                operationDisplayTasks(filteredData);
            }

            function operationDisplayTasks(data) {
                const taskList = document.getElementById('operation-task-list');
                const completedTasks = document.getElementById('operation-completed-tasks');
                taskList.innerHTML = '';
                completedTasks.innerHTML = '';

                const pendingTasks = data.filter(row => row.status !== 'งานเสร็จสิ้น');
                const completedTaskData = data.filter(row => row.status === 'งานเสร็จสิ้น');

                const totalPagesPending = Math.ceil(pendingTasks.length / operationItemsPerPage);
                if (currentPagePendingOperation > totalPagesPending) currentPagePendingOperation = totalPagesPending || 1;
                const totalPagesCompleted = Math.ceil(completedTaskData.length / operationItemsPerPage);
                if (currentPageCompletedOperation > totalPagesCompleted) currentPageCompletedOperation = totalPagesCompleted || 1;

                const taskListHeading = document.createElement('h3');
                taskListHeading.className = 'text-lg font-semibold mb-2';
                taskListHeading.textContent = 'งานที่ต้องทำ';
                taskList.appendChild(taskListHeading);

                const startPending = (currentPagePendingOperation - 1) * operationItemsPerPage;
                const endPending = startPending + operationItemsPerPage;
                const tasksToDisplay = pendingTasks.slice(startPending, endPending);

                tasksToDisplay.forEach(row => {
                    const card = document.createElement('div');
                    card.className = 'border-green rounded-lg p-4 mb-4';

                    const header = document.createElement('div');
                    header.className = 'grid grid-cols-3 gap-4 border-b pb-2';

                    const statusContainer = document.createElement('div');
                    statusContainer.className = 'flex flex-col items-start';
                    const statusLabel = document.createElement('span');
                    statusLabel.textContent = 'สถานะ';
                    statusLabel.className = 'text-sm text-gray-600 mb-1';
                    const statusSpan = document.createElement('span');
                    statusSpan.textContent = row.status;
                    statusSpan.className = 'font-normal text-base';
                    statusContainer.appendChild(statusLabel);
                    statusContainer.appendChild(statusSpan);

                    const nameContainer = document.createElement('div');
                    nameContainer.className = 'flex flex-col items-start';
                    const nameLabel = document.createElement('span');
                    nameLabel.textContent = 'เคสที่';
                    nameLabel.className = 'text-sm text-gray-600 mb-1';
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = row.workorder || '';
                    nameSpan.className = 'font-normal text-base';
                    nameContainer.appendChild(nameLabel);
                    nameContainer.appendChild(nameSpan);

                    const detailsContainer = document.createElement('div');
                    detailsContainer.className = 'flex flex-col items-start';
                    const detailsLabel = document.createElement('span');
                    detailsLabel.textContent = 'รายละเอียด';
                    detailsLabel.className = 'text-sm text-gray-600 mb-1';
                    const detailsButton = document.createElement('button');
                    detailsButton.className = 'text-blue-500 underline';
                    detailsButton.textContent = 'เพิ่มเติม';
                    detailsButton.onclick = () => operationOpenViewDetailsModal(row.idkey);
                    detailsContainer.appendChild(detailsLabel);
                    detailsContainer.appendChild(detailsButton);

                    header.appendChild(statusContainer);
                    header.appendChild(nameContainer);
                    header.appendChild(detailsContainer);

                    const actionButtons = document.createElement('div');
                    actionButtons.className = 'grid grid-cols-4 gap-4 mt-2 text-sm';

                    const startButton = document.createElement('button');
                    startButton.className = 'bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 transition';
                    startButton.textContent = 'เริ่มเดินทาง';
                    startButton.onclick = () => operationOpenStartJobModal(row.idkey);

                    const processButton = document.createElement('button');
                    processButton.className = 'bg-yellow-500 text-white py-2 px-4 rounded-lg hover:bg-yellow-600 transition';
                    processButton.textContent = 'ถึงหน้างาน';
                    processButton.onclick = () => operationOpenProcessJobModal(row.idkey);

                    const startWorkButton = document.createElement('button');
                    startWorkButton.className = 'bg-purple-500 text-white py-2 px-4 rounded-lg hover:bg-purple-600 transition';
                    startWorkButton.textContent = 'เริ่มงาน';
                    startWorkButton.onclick = () => operationOpenStartWorkModal(row.idkey);

                    const completeButton = document.createElement('button');
                    completeButton.className = 'bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition';
                    completeButton.textContent = 'งานเสร็จสิ้น';
                    completeButton.onclick = () => operationOpenCompleteJobModal(row.idkey);

                    // ปรับการ disable ปุ่มตามสถานะ
                    switch (row.status) {
                        case 'รอดำเนินการ':
                            processButton.disabled = true;
                            startWorkButton.disabled = true;
                            completeButton.disabled = true;
                            processButton.classList.add('disabled-button');
                            startWorkButton.classList.add('disabled-button');
                            completeButton.classList.add('disabled-button');
                            break;
                        case 'กำลังเดินทาง':
                            startButton.disabled = true;
                            startWorkButton.disabled = true;
                            completeButton.disabled = true;
                            startButton.classList.add('disabled-button');
                            startWorkButton.classList.add('disabled-button');
                            completeButton.classList.add('disabled-button');
                            break;
                        case 'ถึงจุดหมาย':
                            startButton.disabled = true;
                            processButton.disabled = true;
                            completeButton.disabled = true;
                            startButton.classList.add('disabled-button');
                            processButton.classList.add('disabled-button');
                            completeButton.classList.add('disabled-button');
                            break;
                        case 'กำลังเริ่มงาน':
                            startButton.disabled = true;
                            processButton.disabled = true;
                            startWorkButton.disabled = true;
                            startButton.classList.add('disabled-button');
                            processButton.classList.add('disabled-button');
                            startWorkButton.classList.add('disabled-button');
                            break;
                        case 'งานเสร็จสิ้น':
                            startButton.disabled = true;
                            processButton.disabled = true;
                            completeButton.disabled = true;
                            startButton.classList.add('disabled-button');
                            processButton.classList.add('disabled-button');
                            completeButton.classList.add('disabled-button');
                            break;
                        default:
                            break;
                    }

                    actionButtons.appendChild(startButton);
                    actionButtons.appendChild(processButton);
                    actionButtons.appendChild(startWorkButton);
                    actionButtons.appendChild(completeButton);

                    card.appendChild(header);
                    card.appendChild(actionButtons);
                    taskList.appendChild(card);
                });

                if (totalPagesPending > 1) {
                    const paginationDiv = operationDisplayPagination(totalPagesPending, currentPagePendingOperation, 'pending');
                    taskList.appendChild(paginationDiv);
                }

                const completedTasksHeading = document.createElement('h3');
                completedTasksHeading.className = 'text-lg font-semibold mb-2 mt-4';
                completedTasksHeading.textContent = 'เลื่อน/สำเร็จ';
                completedTasks.appendChild(completedTasksHeading);

                const completedHeader = document.createElement('div');
                completedHeader.className = 'flex justify-between font-bold mb-2';
                completedHeader.innerHTML = `<span>สถานะ</span><span>ชื่อ</span><span>รายละเอียด</span>`;
                completedTasks.appendChild(completedHeader);

                const startCompleted = (currentPageCompletedOperation - 1) * operationItemsPerPage;
                const endCompleted = startCompleted + operationItemsPerPage;
                const completedToDisplay = completedTaskData.slice(startCompleted, endCompleted);

                completedToDisplay.forEach(row => {
                    const taskItem = document.createElement('div');
                    taskItem.className = 'flex justify-between py-2';
                    const statusSpan = document.createElement('span');
                    statusSpan.textContent = row.status;
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = row.Name || '';
                    const detailsButton = document.createElement('button');
                    detailsButton.className = 'text-blue-500';
                    detailsButton.textContent = 'เพิ่มเติม';
                    detailsButton.onclick = () => operationOpenViewDetailsModal(row.idkey);
                    taskItem.appendChild(statusSpan);
                    taskItem.appendChild(nameSpan);
                    taskItem.appendChild(detailsButton);
                    completedTasks.appendChild(taskItem);
                });

                if (totalPagesCompleted > 1) {
                    const paginationDiv = operationDisplayPagination(totalPagesCompleted, currentPageCompletedOperation, 'completed');
                    completedTasks.appendChild(paginationDiv);
                }
            }

            window.operationOpenViewDetailsModal = function (idkey) {
                const row = operationTableData.find(row => row.idkey === idkey);
                if (row) {
                    const detailsContent = document.getElementById('operation-details-content');
                    detailsContent.innerHTML = `
            <p><strong>PO:</strong> ${row.idkey}</p>
            <p><strong>สถานะ:</strong> ${row.status}</p>
            <p><strong>เวลาเริ่มงาน (กำลังเดินทาง):</strong> ${operationFormatDateToDDMMYYYYHHmm(row.timeInside)}</p>
            <p><strong>หมายเหตุ:</strong> ${row.insideNote || ''}</p>
            <p><strong>เวลาเมื่อถึงจุดหมาย:</strong> ${operationFormatDateToDDMMYYYYHHmm(row.timeProcess)}</p>
            <p><strong>หมายเหตุ:</strong> ${row.processNote || ''}</p>
            <p><strong>เวลาเริ่มงาน (กำลังเริ่มงาน):</strong> ${operationFormatDateToDDMMYYYYHHmm(row["time-start"])}</p>
            <p><strong>หมายเหตุ:</strong> ${row["start-note"] || ''}</p>
            <p><strong>เวลาเสร็จสิ้น:</strong> ${operationFormatDateToDDMMYYYYHHmm(row.timeCompress)}</p>
            <p><strong>หมายเหตุ:</strong> ${row.compressNote || ''}</p>
            <p><strong>อัพโหลดรูป:</strong> ${row.compressPhoto ? `<a href="${row.compressPhoto}" target="_blank" class="text-blue-500 underline">ดูรูป</a>` : 'ไม่มี'}</p>
            <p><strong>ชื่อ:</strong> ${row.Name || ''}</p>
            <p><strong>ชื่อผู้ดูแล:</strong> ${row.Responsible || ''}</p>
            <p><strong>ผู้มอบหมาย:</strong> ${row.Admin || ''}</p>
            <p><strong>บันทึกเวลา:</strong> ${operationFormatDateToDDMMYYYYHHmm(row.timestamp)}</p>
          `;
                    document.getElementById('operation-view-details-modal').classList.remove('hidden');
                }
            }

            window.operationCloseViewDetailsModal = function () {
                document.getElementById('operation-view-details-modal').classList.add('hidden');
            }

            // Modal สำหรับ "กำลังเดินทาง"
            window.operationOpenStartJobModal = function (idkey) {
                const row = operationTableData.find(row => row.idkey === idkey);
                if (row) {
                    document.getElementById('operation-start-job-idkey').value = row.idkey;
                    document.getElementById('operation-start-time-inside').value = operationGetCurrentDateTimeGMT7();
                    document.getElementById('operation-start-inside-note').value = row.insideNote || '';
                    document.getElementById('operation-start-status').value = 'กำลังเดินทาง';
                    document.getElementById('operation-start-job-modal').classList.remove('hidden');
                }
            }
            window.operationCloseStartJobModal = function () {
                document.getElementById('operation-start-job-modal').classList.add('hidden');
            }

            document.getElementById('operation-start-job-form').addEventListener('submit', async function (e) {
                e.preventDefault();
                const submitButton = this.querySelector("button[type=submit]");
                const originalText = submitButton.textContent;
                submitButton.disabled = true;
                submitButton.textContent = 'กำลังอัพเดท...';
                const idkey = document.getElementById('operation-start-job-idkey').value;
                const status = document.getElementById('operation-start-status').value;
                const timeInside = document.getElementById('operation-start-time-inside').value;
                const insideNote = document.getElementById('operation-start-inside-note').value.trim();
                if (!idkey || !status || !timeInside) {
                    Swal.fire({ icon: 'warning', title: 'คำเตือน', text: 'กรุณากรอกข้อมูลที่จำเป็นให้ครบถ้วน' });
                    submitButton.disabled = false;
                    submitButton.textContent = originalText;
                    return;
                }
                const formattedTimeInside = operationFormatDateForSubmit(timeInside);
                try {
                    const response = await fetch(WEB_APP_URL_OPERATION, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `method=startJob&idkey=${encodeURIComponent(idkey)}&timeInside=${encodeURIComponent(formattedTimeInside)}&insideNote=${encodeURIComponent(insideNote)}&status=${encodeURIComponent(status)}`
                    });
                    const result = await response.json();
                    if (result.success) {
                        Swal.fire({ title: 'สำเร็จ', text: result.message, icon: 'success' });
                        operationCloseStartJobModal();
                        operationFetchData(operationCurrentUserId);
                    } else {
                        Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: result.message });
                    }
                } catch (error) {
                    console.error('Error updating data:', error);
                    Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: 'ไม่สามารถอัปเดตข้อมูลได้' });
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = originalText;
                }
            });

            // Modal สำหรับ "ถึงจุดหมาย"
            window.operationOpenProcessJobModal = function (idkey) {
                const row = operationTableData.find(row => row.idkey === idkey);
                if (row) {
                    document.getElementById('operation-process-job-idkey').value = row.idkey;
                    document.getElementById('operation-process-time-process').value = operationGetCurrentDateTimeGMT7();
                    document.getElementById('operation-process-process-note').value = row.processNote || '';
                    document.getElementById('operation-process-status').value = 'ถึงจุดหมาย';
                    document.getElementById('operation-process-job-modal').classList.remove('hidden');
                }
            }
            window.operationCloseProcessJobModal = function () {
                document.getElementById('operation-process-job-modal').classList.add('hidden');
            }

            document.getElementById('operation-process-job-form').addEventListener('submit', async function (e) {
                e.preventDefault();
                const submitButton = this.querySelector("button[type=submit]");
                const originalText = submitButton.textContent;
                submitButton.disabled = true;
                submitButton.textContent = 'กำลังอัพเดท...';
                const idkey = document.getElementById('operation-process-job-idkey').value;
                const status = document.getElementById('operation-process-status').value;
                const timeProcess = document.getElementById('operation-process-time-process').value;
                const processNote = document.getElementById('operation-process-process-note').value.trim();
                if (!idkey || !status || !timeProcess) {
                    Swal.fire({ icon: 'warning', title: 'คำเตือน', text: 'กรุณากรอกข้อมูลที่จำเป็นให้ครบถ้วน' });
                    submitButton.disabled = false;
                    submitButton.textContent = originalText;
                    return;
                }
                const formattedTimeProcess = operationFormatDateForSubmit(timeProcess);
                try {
                    const response = await fetch(WEB_APP_URL_OPERATION, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `method=processJob&idkey=${encodeURIComponent(idkey)}&timeProcess=${encodeURIComponent(formattedTimeProcess)}&processNote=${encodeURIComponent(processNote)}&status=${encodeURIComponent(status)}`
                    });
                    const result = await response.json();
                    if (result.success) {
                        Swal.fire({ title: 'สำเร็จ', text: result.message, icon: 'success' });
                        operationCloseProcessJobModal();
                        operationFetchData(operationCurrentUserId);
                    } else {
                        Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: result.message });
                    }
                } catch (error) {
                    console.error('Error updating data:', error);
                    Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: 'ไม่สามารถอัปเดตข้อมูลได้' });
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = originalText;
                }
            });

            // Modal สำหรับ "กำลังเริ่มงาน" (ขั้นตอนใหม่)
            window.operationOpenStartWorkModal = function (idkey) {
                const row = operationTableData.find(row => row.idkey === idkey);
                if (row) {
                    document.getElementById('operation-start-work-idkey').value = row.idkey;
                    document.getElementById('operation-start-work-time').value = operationGetCurrentDateTimeGMT7();
                    document.getElementById('operation-start-work-note').value = row["start-note"] || '';
                    document.getElementById('operation-start-work-status').value = 'กำลังเริ่มงาน';
                    document.getElementById('operation-start-work-modal').classList.remove('hidden');
                }
            }
            window.operationCloseStartWorkModal = function () {
                document.getElementById('operation-start-work-modal').classList.add('hidden');
            }

            document.getElementById('operation-start-work-form').addEventListener('submit', async function (e) {
                e.preventDefault();
                const submitButton = this.querySelector("button[type=submit]");
                const originalText = submitButton.textContent;
                submitButton.disabled = true;
                submitButton.textContent = 'กำลังอัพเดท...';
                const idkey = document.getElementById('operation-start-work-idkey').value;
                const status = document.getElementById('operation-start-work-status').value;
                const timeStart = document.getElementById('operation-start-work-time').value;
                const startNote = document.getElementById('operation-start-work-note').value.trim();
                if (!idkey || !status || !timeStart) {
                    Swal.fire({ icon: 'warning', title: 'คำเตือน', text: 'กรุณากรอกข้อมูลที่จำเป็นให้ครบถ้วน' });
                    submitButton.disabled = false;
                    submitButton.textContent = originalText;
                    return;
                }
                const formattedTimeStart = operationFormatDateForSubmit(timeStart);
                try {
                    const response = await fetch(WEB_APP_URL_OPERATION, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `method=startJobAction&idkey=${encodeURIComponent(idkey)}&timeStart=${encodeURIComponent(formattedTimeStart)}&startNote=${encodeURIComponent(startNote)}&status=${encodeURIComponent(status)}`
                    });
                    const result = await response.json();
                    if (result.success) {
                        Swal.fire({ title: 'สำเร็จ', text: result.message, icon: 'success' });
                        operationCloseStartWorkModal();
                        operationFetchData(operationCurrentUserId);
                    } else {
                        Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: result.message });
                    }
                } catch (error) {
                    console.error('Error updating data:', error);
                    Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: 'ไม่สามารถอัปเดตข้อมูลได้' });
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = originalText;
                }
            });

            // Modal สำหรับ "งานเสร็จสิ้น"
            window.operationOpenCompleteJobModal = function (idkey) {
                const row = operationTableData.find(row => row.idkey === idkey);
                if (row) {
                    document.getElementById('operation-complete-job-idkey').value = row.idkey;
                    document.getElementById('operation-complete-time-compress').value = operationGetCurrentDateTimeGMT7();
                    document.getElementById('operation-complete-compress-note').value = row.compressNote || '';
                    document.getElementById('operation-complete-compress-photo').value = '';
                    document.getElementById('operation-complete-status').value = 'งานเสร็จสิ้น';
                    document.getElementById('operation-complete-job-modal').classList.remove('hidden');
                }
            }
            window.operationCloseCompleteJobModal = function () {
                document.getElementById('operation-complete-job-modal').classList.add('hidden');
            }

            document.getElementById('operation-complete-job-form').addEventListener('submit', async function (e) {
                e.preventDefault();
                const submitButton = this.querySelector("button[type=submit]");
                const originalText = submitButton.textContent;
                submitButton.disabled = true;
                submitButton.textContent = 'กำลังอัพเดท...';
                const idkey = document.getElementById('operation-complete-job-idkey').value;
                const status = document.getElementById('operation-complete-status').value;
                const timeCompress = document.getElementById('operation-complete-time-compress').value;
                const compressNote = document.getElementById('operation-complete-compress-note').value.trim();
                const compressPhotoInput = document.getElementById('operation-complete-compress-photo');
                const compressPhotoFile = compressPhotoInput.files[0];
                let compressPhotoData = '';
                if (compressPhotoFile) {
                    compressPhotoData = await operationReadFileAsBase64(compressPhotoFile);
                }
                if (!idkey || !status || !timeCompress) {
                    Swal.fire({ icon: 'warning', title: 'คำเตือน', text: 'กรุณากรอกข้อมูลที่จำเป็นให้ครบถ้วน' });
                    submitButton.disabled = false;
                    submitButton.textContent = originalText;
                    return;
                }
                const formattedTimeCompress = operationFormatDateForSubmit(timeCompress);
                try {
                    let bodyParams = `method=completeJob&idkey=${encodeURIComponent(idkey)}&timeCompress=${encodeURIComponent(formattedTimeCompress)}&compressNote=${encodeURIComponent(compressNote)}&status=${encodeURIComponent(status)}`;
                    if (compressPhotoData) {
                        bodyParams += `&compressPhotoData=${encodeURIComponent(compressPhotoData)}`;
                    }
                    const response = await fetch(WEB_APP_URL_OPERATION, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: bodyParams
                    });
                    const result = await response.json();
                    if (result.success) {
                        Swal.fire({ title: 'สำเร็จ', text: result.message, icon: 'success' });
                        operationCloseCompleteJobModal();
                        operationFetchData(operationCurrentUserId);
                    } else {
                        Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: result.message });
                    }
                } catch (error) {
                    console.error('Error updating data:', error);
                    Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: 'ไม่สามารถอัปเดตข้อมูลได้' });
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = originalText;
                }
            });

            function operationReadFileAsBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const base64 = e.target.result.split(',')[1];
                        resolve(base64);
                    };
                    reader.onerror = function (e) {
                        reject(e);
                    };
                    reader.readAsDataURL(file);
                });
            }

            function operationGetCurrentDateTimeGMT7() {
                const now = new Date();
                const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
                const gmt7Time = new Date(utc + (7 * 3600000));
                const year = gmt7Time.getFullYear();
                const month = String(gmt7Time.getMonth() + 1).padStart(2, '0');
                const day = String(gmt7Time.getDate()).padStart(2, '0');
                const hours = String(gmt7Time.getHours()).padStart(2, '0');
                const minutes = String(gmt7Time.getMinutes()).padStart(2, '0');
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            }

            function operationFormatDateToDDMMYYYYHHmm(dateStr) {
                if (!dateStr) return '';
                let date;
                if (dateStr.includes('/') && dateStr.includes(':')) {
                    date = operationParseDateDDMMYYYYHHmm(dateStr);
                } else {
                    date = new Date(dateStr);
                }
                if (!date || isNaN(date.getTime())) return '';
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${day}/${month}/${year} ${hours}:${minutes}`;
            }

            function operationParseDateDDMMYYYYHHmm(dateStr) {
                if (!dateStr) return null;
                const parts = dateStr.split(' ');
                if (parts.length !== 2) return null;
                const [datePart, timePart] = parts;
                const [day, month, year] = datePart.split('/').map(Number);
                const [hours, minutes] = timePart.split(':').map(Number);
                return new Date(year, month - 1, day, hours, minutes);
            }

            function operationFormatDateForSubmit(datetimeLocal) {
                if (!datetimeLocal) return '';
                const date = new Date(datetimeLocal);
                if (isNaN(date.getTime())) return '';
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${day}/${month}/${year} ${hours}:${minutes}`;
            }

            function operationDisplayPagination(pages, currentPage, type) {
                const paginationDiv = document.createElement('div');
                paginationDiv.className = 'flex justify-center mt-4 space-x-2';
                const prevButton = document.createElement('button');
                prevButton.className = 'bg-gray-500 text-white py-1 px-3 rounded-lg';
                prevButton.textContent = 'ก่อนหน้า';
                prevButton.disabled = currentPage === 1;
                prevButton.onclick = () => {
                    if (type === 'pending') { currentPagePendingOperation--; } else { currentPageCompletedOperation--; }
                    operationApplyFilters();
                };
                const nextButton = document.createElement('button');
                nextButton.className = 'bg-gray-500 text-white py-1 px-3 rounded-lg';
                nextButton.textContent = 'ถัดไป';
                nextButton.disabled = currentPage === pages;
                nextButton.onclick = () => {
                    if (type === 'pending') { currentPagePendingOperation++; } else { currentPageCompletedOperation++; }
                    operationApplyFilters();
                };
                paginationDiv.appendChild(prevButton);
                paginationDiv.appendChild(nextButton);
                return paginationDiv;
            }

            function createTimelineSteps(params) {
                const steps = [];
                const timelineSteps = [
                    {
                        title: "กำลังเดินทาง",
                        datetime: params.timeInside,
                        note: params.insideNote
                    },
                    {
                        title: "ถึงจุดหมาย",
                        datetime: params.timeProcess,
                        note: params.processNote
                    },
                    {
                        title: "กำลังเริ่มงาน",
                        datetime: params.timeStart,
                        note: params.startNote
                    },
                    {
                        title: "งานเสร็จสิ้น",
                        datetime: params.timeCompress,
                        note: params.compressNote
                    }
                ];
                timelineSteps.forEach((step, index) => {
                    if (step.datetime || step.note) {
                        const { date, time } = formatDateTime(step.datetime);
                        steps.push({
                            type: "box",
                            layout: "horizontal",
                            margin: "md",
                            contents: [
                                {
                                    type: "box",
                                    layout: "vertical",
                                    contents: [
                                        { type: "text", text: date, size: "sm", color: "#333333", align: "start" },
                                        { type: "text", text: time, size: "sm", color: "#333333", align: "start" }
                                    ],
                                    flex: 2
                                },
                                {
                                    type: "box",
                                    layout: "vertical",
                                    contents: [
                                        {
                                            type: "box",
                                            layout: "vertical",
                                            contents: [],
                                            width: "12px",
                                            height: "12px",
                                            borderWidth: "2px",
                                            borderColor: "#1DB446",
                                            cornerRadius: "30px",
                                            backgroundColor: "#ffffff"
                                        },
                                        ...(index < timelineSteps.length - 1 ? [{
                                            type: "box",
                                            layout: "vertical",
                                            contents: [],
                                            width: "2px",
                                            height: "40px",
                                            backgroundColor: "#B7B7B7"
                                        }] : [])
                                    ],
                                    flex: 1,
                                    alignItems: "center"
                                },
                                {
                                    type: "box",
                                    layout: "vertical",
                                    contents: [
                                        { type: "text", text: step.title, size: "sm", weight: "bold", color: "#000000", wrap: true },
                                        { type: "text", text: `📝 ${step.note || '-'}`, size: "sm", color: "#333333", wrap: true }
                                    ],
                                    flex: 4
                                }
                            ]
                        });
                    }
                });
                return steps;
            }

            function formatDateTime(datetime) {
                if (!datetime) return { date: '-', time: '-' };
                const dateObj = new Date(datetime);
                const date = dateObj.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
                const time = dateObj.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                return { date, time };
            }

            window.operationInitialize = function () {
                operationInitializeLiff();
            };

            window.addEventListener('load', operationInitialize);
        })();
    </script>
</body>

</html>
